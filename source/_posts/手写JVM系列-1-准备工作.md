---
title: 手写JVM系列(1)-准备工作
date: 2017-05-06 22:20:06
tags: JVM
---

> 本系列文章主要根据张秀宏老师的—— 《自己动手写java虚拟机》一书所做的笔记。该书实现了大部分 JVM 自带的特性，包括 IO、类加载、线程、Unsafe 等等。这本书可以说是了解Java虚拟机最浅显易懂的书籍，随书提供了每个章节的代码，可以完美运行。但是这本书所附带的代码是用go语言书写的，如果想要看懂这本书的代码，首先要学会go语言的基本语法。这边博客记录了在阅读这本书之前的准备工作。我在练习中是根据张老师的代码用Java语言又实现了一遍。虽然用Java语言在实现一个自己的虚拟机，然后跑在自带的虚拟机上有点滑稽，但是重点还是了解虚拟机内部的基本原理。

贴出张秀宏老师这本书的[代码](https://github.com/zxh0/jvmgo-book)
同时贴出我用Java实现的相同功能的[代码](https://github.com/zachaxy/JVM)

# 安装Go开发环境

## 下载

[Golang中国](http://golangtc.com/download),这个下载速度快一点,下载最新版本之后一路`next`即可。

安装后，其实安装脚本已经自动帮我们把Go的安装路径添加到系统的环境变量中了， 查看系统环境变量，发现多了一个 `GOROOT`,其值为:`C:\go`(默认的安装路径)并且在`path`中,也自动把 `GOROOT\bin`添加了进来,因此直接打开命令行窗口,输入`go version`命令,就会输出安装的`go`的版本信息.

## 配置环境

既然上一步安装`Go`时已经添加了环境变量了,那么接下来还要配置什么呢?



`Go`希望我们把所有的代码都存在在同一个目录下,这就好比我们用`eclipse`时需要一个`workspace`,但是`eclipse`中的`workspace`可以有多个,而`Go`希望在一台主机上只有一个`workspace`,所以我们在这里要指定一个,例如`D:\workspace`,这个位置随意,文件夹名字随意,然后和`Go`进行关联,这里的关联方法就是在环境变量中,添加一个`GOPATH`,其值为刚刚设定的`D:\workspace`



接下来,在`D:\workspace`中添加一个目录`src`,这一步是必须的,所有的`Go`源代码都必须放在这个`src`目录下,那有人问,如果我有多个项目,所有源代码都放在这个目录下,怎么分清哪个源代码归属于哪个项目呢? 方法很简单,就是在`src`目录下再用不同的文件夹作为分隔,一个项目一个文件夹,自然就分开了;



## Go语言的包结构

`Go`语言以包为单位组织源代码，包可以嵌套，形成层次关系。书中编写的`Go`源文件全部放在`jvmgo`包中，其中每一章的源文件又分别放在自己的子包中。包层次目录结构有一个简单的对应关系，比如，第1章的代码在`jvmgo\ch01`目录下。除第1章以外，每一章都是先复制前一章代码，然后进行修改和完善。每一章的代码都是独立的，可以单独编译为一个可执行文件。

所形成的目录结构是:

```
- D:\workspace
	- src
		- jvmgo
			- ch01
			- ch02
			...
```



在每一个章节的chX中,都会有一个`main`的包,这个包中的某个文件一定包含一个`main`方法,因为这里每个子文件被看做一个独立的工程.这个也很好理解,因为`Java`工程中,每个`Java`都可以有一个`public static void main(String[] args)`方法,这一点不足为奇,但是要注意的是,一旦你选定某个子文件为一个项目(eg:jvmgo/ch05),并且使用` go install jvmgo\ch05`

来生成一个exe文件, 那么这个目录下只能有一个`main`方法,不能有多个,否则就报错,类似于

```
E:\workspace\src\jvmgo\ch05\main2.go:3: main redeclared in this block
        previous declaration at E:\workspace\src\jvmgo\ch05\main.go:8
```

这是因为我在`main.go`中声明了一个`main`方法,又在`main2.go`中声明了一个`main`方法,所以就报了重复定义的错误.

还有一点要说明的是:可以直接在命令行输入` go install your/package/name`系统会自动从`GOROOT/src`和`GOPATH/src`两个文件中找`your/package/name`,而不用非进入到`GOPATH/src`路径下执行,而且如果`your/package/name`在上述两个路径中均存在,那么前者优先级更高.



前面是使用`go install`命令生成可执行文件,但是如果你使用 `go run xxx.go`,那么不用保证xxx.go所在的包中`main`方法是唯一的,`main`包中其它文件也可以包含`main`方法,因为你运行的是单个文件,不过这只是自己平时练习时用,真正的项目都不会只有单个文件那么简单.





# 快速入门Go语言

因为本项目是想用`Java`实现书中的`JVM`项目,而书中所提供的是`Go`的源码,所以这里只要求能看懂`Go`的代码就可以,不必深入细节,相信看到这篇文章,想学习`JVM`,那么你的`Java`语言一定已经很熟练了,那么再快速学习一门语言是很快的,这里推荐[Go的官方教程](https://tour.golang.org/welcome/1),一天就能看完,一顶要有耐心.



上面提供的网站很不稳定,如果人品好的话,打开之后,赶紧一口气学完;运气差点肯定就打不开,没关系,这里有离线的版本,效果是一样的;

如果你已经安装好了`Go`的开发环境,那么直接打开命令行,输入`go tool tour`,浏览器就会自动打开一个页面,和在线版是一样,而且速度很快,你可以在右侧的代码区编写自己的代码并运行,这里代码的改动都是保存在本地的.





# 关于编译器

这里推荐使用 `Intellij idea + 插件`的方式,这里主要是为了看代码方便,可以很方便的实现方法之间的跳转,

## 插件安装

打开`idea`的`setting->plugin`,搜索`go`,点击下方的`Browse repositorise`,找到`Go language(golang.org)support plugin`,[官网地址](https://github.com/go-lang-plugin-org),安装后重启`idea`即可.



但是也存在很多问题,比如无法 debug!!!不过问题不大,我们主要目的是方便的查看源码.



## 用idea看源码

为了配合`idea`阅读《自己动手写java虚拟机》的源码,这里最简单的做法:

1. 新建一个go项目,命名为`jvmgo`,路径为`GOPATH/src`
2. 需要看哪一章的源码,就把作者对应的 `jvmgo/`文件夹下的`ch01`(以第一章为例),复制到上一步新建的项目路径下,最终结果应该是:`GOPATH/src/jvmgo/ch01`